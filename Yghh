namespace AlerAudio.Models
{
    public class Overtime
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public double Hours { get; set; }

        // Thời gian đăng ký về (giờ:phút được người dùng đăng ký)
        public TimeSpan RegisteredEndTime { get; set; }

        // Thời gian thực tế về (Date + RegisteredEndTime)
        public DateTime ActualEndTime
        {
            get
            {
                return Date.Date.Add(RegisteredEndTime);
            }
        }
    }
}



using AlerAudio.Models;

namespace AlerAudio.Services
{
    public class OvertimeRepository : IOvertimeRepository
    {
        // Demo data - Thay thế bằng database thực tế
        public async Task<List<Overtime>> GetOvertimesAsync()
        {
            // TODO: Kết nối với database thực tế
            // Ví dụ data demo - Người dùng đăng ký giờ về
            var today = DateTime.Today;
            
            return await Task.FromResult(new List<Overtime>
            {
                new Overtime 
                { 
                    Code = "NV001", 
                    Name = "Nguyễn Văn A", 
                    Date = today,
                    Hours = 0, // Không dùng Hours nữa
                    RegisteredEndTime = new TimeSpan(17, 30, 0) // Đăng ký về lúc 17:30
                },
                new Overtime 
                { 
                    Code = "NV002", 
                    Name = "Trần Thị B", 
                    Date = today,
                    Hours = 0,
                    RegisteredEndTime = new TimeSpan(17, 30, 0) // Đăng ký về lúc 17:30 (cùng với A)
                },
                new Overtime 
                { 
                    Code = "NV003", 
                    Name = "Lê Văn C", 
                    Date = today,
                    Hours = 0,
                    RegisteredEndTime = new TimeSpan(17, 40, 0) // Đăng ký về lúc 17:40
                },
                new Overtime 
                { 
                    Code = "NV004", 
                    Name = "Phạm Văn D", 
                    Date = today,
                    Hours = 0,
                    RegisteredEndTime = new TimeSpan(17, 45, 0) // Đăng ký về lúc 17:45
                },
                new Overtime 
                { 
                    Code = "NV005", 
                    Name = "Hoàng Thị E", 
                    Date = today,
                    Hours = 0,
                    RegisteredEndTime = new TimeSpan(17, 45, 0) // Đăng ký về lúc 17:45 (cùng với D)
                }
            });
        }
    }
}



using AlerAudio.Models;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace AlerAudio.Services
{
    public class OvertimeAlertService : BackgroundService
    {
        private readonly IOvertimeRepository _overtimeRepository;
        private readonly ITextToSpeechService _textToSpeechService;
        private readonly ILogger<OvertimeAlertService> _logger;
        private readonly HashSet<string> _alertedCodes = new HashSet<string>();
        private readonly int _checkIntervalSeconds = 60;
        private readonly int _alertMinutesBefore = 2; // Cảnh báo trước 2 phút

        public OvertimeAlertService(
            IOvertimeRepository overtimeRepository,
            ITextToSpeechService textToSpeechService,
            ILogger<OvertimeAlertService> logger)
        {
            _overtimeRepository = overtimeRepository;
            _textToSpeechService = textToSpeechService;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("Overtime Alert Service đang chạy...");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    await CheckAndAlertAsync();
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Lỗi khi kiểm tra overtime");
                }

                // Đợi 60 giây trước khi kiểm tra lần tiếp theo
                await Task.Delay(TimeSpan.FromSeconds(_checkIntervalSeconds), stoppingToken);
            }
        }

        private async Task CheckAndAlertAsync()
        {
            var overtimes = await _overtimeRepository.GetOvertimesAsync();
            var now = DateTime.Now;

            // Lọc những người sắp đến giờ về (trong vòng 2 phút tới)
            var upcomingEndTimes = overtimes
                .Where(o => !_alertedCodes.Contains(o.Code)) // Chưa được cảnh báo
                .Where(o => o.ActualEndTime >= now && o.ActualEndTime <= now.AddMinutes(_alertMinutesBefore))
                .OrderBy(o => o.ActualEndTime)
                .ToList();

            if (upcomingEndTimes.Any())
            {
                _logger.LogInformation($"Tìm thấy {upcomingEndTimes.Count} người sắp đến giờ về");

                // Nhóm theo giờ đăng ký (giờ:phút giống nhau)
                var groupedByTime = upcomingEndTimes
                    .GroupBy(o => o.RegisteredEndTime)
                    .OrderBy(g => g.Key)
                    .ToList();

                _logger.LogInformation($"Có {groupedByTime.Count} khung giờ khác nhau");

                foreach (var group in groupedByTime)
                {
                    var employees = group.ToList();
                    var registeredTime = group.Key.ToString(@"hh\:mm");
                    
                    if (employees.Count == 1)
                    {
                        // Chỉ 1 người đăng ký giờ này
                        var employee = employees[0];
                        _logger.LogInformation($"Thông báo: {employee.Code} - {employee.Name} (Đăng ký về lúc {registeredTime})");
                        
                        // Lặp lại 3 lần: Mở đầu -> Tên -> Kết thúc
                        for (int i = 0; i < 3; i++)
                        {
                            _logger.LogInformation($"Lần thông báo {i + 1}/3");
                            
                            await _textToSpeechService.PlayStartAudioAsync();
                            await Task.Delay(300);
                            await _textToSpeechService.PlayAudioFileAsync(employee.Code);
                            await Task.Delay(300);
                            await _textToSpeechService.PlayEndAudioAsync();
                            
                            if (i < 2)
                            {
                                await Task.Delay(2000);
                            }
                        }
                        
                        _alertedCodes.Add(employee.Code);
                    }
                    else
                    {
                        // Nhiều người cùng đăng ký giờ này
                        var namesList = string.Join(", ", employees.Select(e => $"{e.Code} {e.Name}"));
                        _logger.LogInformation($"Thông báo nhóm {employees.Count} người đăng ký về lúc {registeredTime}: {namesList}");
                        
                        // Lặp lại 3 lần: Mở đầu -> Danh sách tất cả -> Kết thúc
                        for (int round = 0; round < 3; round++)
                        {
                            _logger.LogInformation($"Lần thông báo {round + 1}/3 cho khung giờ {registeredTime}");
                            
                            await _textToSpeechService.PlayStartAudioAsync();
                            await Task.Delay(500);
                            
                            foreach (var emp in employees)
                            {
                                await _textToSpeechService.PlayAudioFileAsync(emp.Code);
                                await Task.Delay(500);
                            }
                            
                            await Task.Delay(300);
                            await _textToSpeechService.PlayEndAudioAsync();
                            
                            if (round < 2)
                            {
                                await Task.Delay(2000);
                            }
                        }
                        
                        foreach (var emp in employees)
                        {
                            _alertedCodes.Add(emp.Code);
                        }
                    }

                    // Delay giữa các nhóm giờ khác nhau
                    if (groupedByTime.IndexOf(group) < groupedByTime.Count - 1)
                    {
                        _logger.LogInformation("Chuyển sang nhóm giờ tiếp theo...");
                        await Task.Delay(3000);
                    }
                }
            }

            // Reset danh sách đã cảnh báo cho những người đã quá giờ
            var expiredCodes = overtimes
                .Where(o => _alertedCodes.Contains(o.Code) && o.ActualEndTime < now.AddMinutes(-30))
                .Select(o => o.Code)
                .ToList();

            foreach (var code in expiredCodes)
            {
                _alertedCodes.Remove(code);
            }
        }
    }
}
