-- Script t·∫°o b·∫£ng Overtime trong SQL Server
CREATE TABLE Overtime (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Code NVARCHAR(50) NOT NULL,
    Name NVARCHAR(200) NOT NULL,
    Date DATETIME NOT NULL,
    Hours DECIMAL(5,2) NOT NULL,
    CreatedAt DATETIME DEFAULT GETDATE()
);

-- Th√™m d·ªØ li·ªáu m·∫´u
INSERT INTO Overtime (Code, Name, Date, Hours) VALUES
('NV001', N'Nguy·ªÖn VƒÉn A', DATEADD(MINUTE, -115, GETDATE()), 2),
('NV002', N'Tr·∫ßn Th·ªã B', DATEADD(MINUTE, -117, GETDATE()), 2),
('NV003', N'L√™ VƒÉn C', DATEADD(MINUTE, -60, GETDATE()), 2),
('NV004', N'Ph·∫°m VƒÉn D', DATEADD(MINUTE, -118, GETDATE()), 2);

-- Query ki·ªÉm tra
SELECT 
    Code,
    Name,
    Date,
    Hours,
    DATEADD(HOUR, Hours, Date) AS EndTime,
    DATEDIFF(MINUTE, GETDATE(), DATEADD(HOUR, Hours, Date)) AS MinutesUntilEnd
FROM Overtime
WHERE DATEADD(HOUR, Hours, Date) BETWEEN GETDATE() AND DATEADD(MINUTE, 10, GETDATE())
ORDER BY EndTime;


namespace AlerAudio.Models
{
    public class Overtime
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public double Hours { get; set; }

        // Th·ªùi gian d·ª± ki·∫øn v·ªÅ (Date + Hours)
        public DateTime EndTime => Date.AddHours(Hours);
    }
}


using AlerAudio.Models;

namespace AlerAudio.Services
{
    public interface IOvertimeRepository
    {
        Task<List<Overtime>> GetOvertimesAsync();
    }
}

namespace AlerAudio.Services
{
    public interface ITextToSpeechService
    {
        void Speak(string text);
        Task SpeakAsync(string text);
        void PlayAudioFile(string employeeCode);
        Task PlayAudioFileAsync(string employeeCode);
        Task PlayStartAudioAsync();
        Task PlayEndAudioAsync();
    }
}


using AlerAudio.Models;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace AlerAudio.Services
{
    public class OvertimeAlertService : BackgroundService
    {
        private readonly IOvertimeRepository _overtimeRepository;
        private readonly ITextToSpeechService _textToSpeechService;
        private readonly ILogger<OvertimeAlertService> _logger;
        private readonly HashSet<string> _alertedCodes = new HashSet<string>();
        private readonly int _checkIntervalSeconds = 60;
        private readonly int _alertMinutesBefore = 10; // C·∫£nh b√°o tr∆∞·ªõc 10 ph√∫t

        public OvertimeAlertService(
            IOvertimeRepository overtimeRepository,
            ITextToSpeechService textToSpeechService,
            ILogger<OvertimeAlertService> logger)
        {
            _overtimeRepository = overtimeRepository;
            _textToSpeechService = textToSpeechService;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("Overtime Alert Service ƒëang ch·∫°y...");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    await CheckAndAlertAsync();
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "L·ªói khi ki·ªÉm tra overtime");
                }

                // ƒê·ª£i 60 gi√¢y tr∆∞·ªõc khi ki·ªÉm tra l·∫ßn ti·∫øp theo
                await Task.Delay(TimeSpan.FromSeconds(_checkIntervalSeconds), stoppingToken);
            }
        }

        private async Task CheckAndAlertAsync()
        {
            var overtimes = await _overtimeRepository.GetOvertimesAsync();
            var now = DateTime.Now;

            // L·ªçc nh·ªØng ng∆∞·ªùi s·∫Øp ƒë·∫øn gi·ªù v·ªÅ (trong v√≤ng 10 ph√∫t t·ªõi)
            var upcomingEndTimes = overtimes
                .Where(o => !_alertedCodes.Contains(o.Code)) // Ch∆∞a ƒë∆∞·ª£c c·∫£nh b√°o
                .Where(o => o.EndTime >= now && o.EndTime <= now.AddMinutes(_alertMinutesBefore))
                .OrderBy(o => o.EndTime)
                .ToList();

            if (upcomingEndTimes.Any())
            {
                _logger.LogInformation($"T√¨m th·∫•y {upcomingEndTimes.Count} ng∆∞·ªùi s·∫Øp ƒë·∫øn gi·ªù v·ªÅ");

                // Nh√≥m theo khung gi·ªù (c√πng ph√∫t)
                var groupedByTime = upcomingEndTimes
                    .GroupBy(o => new { o.EndTime.Hour, o.EndTime.Minute })
                    .ToList();

                foreach (var group in groupedByTime)
                {
                    var employees = group.ToList();
                    
                    if (employees.Count == 1)
                    {
                        // Ch·ªâ 1 ng∆∞·ªùi - Ph√°t file audio c·ªßa ng∆∞·ªùi ƒë√≥
                        var employee = employees[0];
                        _logger.LogInformation($"Th√¥ng b√°o: M√£ {employee.Code} - {employee.Name}");
                        
                        // L·∫∑p l·∫°i 3 l·∫ßn: M·ªü ƒë·∫ßu -> T√™n -> K·∫øt th√∫c
                        for (int i = 0; i < 3; i++)
                        {
                            _logger.LogInformation($"L·∫ßn th√¥ng b√°o {i + 1}/3");
                            
                            await _textToSpeechService.PlayStartAudioAsync(); // M·ªü ƒë·∫ßu
                            await Task.Delay(300);
                            await _textToSpeechService.PlayAudioFileAsync(employee.Code); // T√™n nh√¢n vi√™n
                            await Task.Delay(300);
                            await _textToSpeechService.PlayEndAudioAsync(); // K·∫øt th√∫c
                            
                            if (i < 2)
                            {
                                await Task.Delay(2000); // Delay 2 gi√¢y gi·ªØa c√°c l·∫ßn l·∫∑p
                            }
                        }
                        
                        _alertedCodes.Add(employee.Code);
                    }
                    else
                    {
                        // Nhi·ªÅu ng∆∞·ªùi c√πng khung gi·ªù
                        var namesList = string.Join(", ", employees.Select(e => $"{e.Code} {e.Name}"));
                        _logger.LogInformation($"Th√¥ng b√°o nh√≥m {employees.Count} ng∆∞·ªùi: {namesList}");
                        
                        // L·∫∑p l·∫°i 3 l·∫ßn: M·ªü ƒë·∫ßu -> Danh s√°ch t·∫•t c·∫£ -> K·∫øt th√∫c
                        for (int round = 0; round < 3; round++)
                        {
                            _logger.LogInformation($"L·∫ßn th√¥ng b√°o {round + 1}/3");
                            
                            // M·ªü ƒë·∫ßu
                            await _textToSpeechService.PlayStartAudioAsync();
                            await Task.Delay(500);
                            
                            // Ph√°t audio c·ªßa T·∫§T C·∫¢ ng∆∞·ªùi trong danh s√°ch
                            foreach (var emp in employees)
                            {
                                await _textToSpeechService.PlayAudioFileAsync(emp.Code);
                                await Task.Delay(500); // Delay ng·∫Øn gi·ªØa c√°c ng∆∞·ªùi
                            }
                            
                            // K·∫øt th√∫c
                            await Task.Delay(300);
                            await _textToSpeechService.PlayEndAudioAsync();
                            
                            if (round < 2)
                            {
                                await Task.Delay(2000); // Delay 2 gi√¢y tr∆∞·ªõc khi l·∫∑p l·∫°i
                            }
                        }
                        
                        foreach (var emp in employees)
                        {
                            _alertedCodes.Add(emp.Code);
                        }
                    }

                    // Delay m·ªôt ch√∫t gi·ªØa c√°c nh√≥m ƒë·ªÉ tr√°nh n√≥i ch·ªìng l√™n nhau
                    if (groupedByTime.IndexOf(group) < groupedByTime.Count - 1)
                    {
                        await Task.Delay(2000);
                    }
                }
            }

            // Reset danh s√°ch ƒë√£ c·∫£nh b√°o cho nh·ªØng ng∆∞·ªùi ƒë√£ qu√° gi·ªù (ƒë·ªÉ tr√°nh tr√†n b·ªô nh·ªõ)
            var expiredCodes = overtimes
                .Where(o => _alertedCodes.Contains(o.Code) && o.EndTime < now.AddMinutes(-30))
                .Select(o => o.Code)
                .ToList();

            foreach (var code in expiredCodes)
            {
                _alertedCodes.Remove(code);
            }
        }
    }
}


using AlerAudio.Models;

namespace AlerAudio.Services
{
    public class OvertimeRepository : IOvertimeRepository
    {
        // Demo data - Thay th·∫ø b·∫±ng database th·ª±c t·∫ø
        public async Task<List<Overtime>> GetOvertimesAsync()
        {
            // TODO: K·∫øt n·ªëi v·ªõi database th·ª±c t·∫ø
            // V√≠ d·ª• data demo - 3 ng∆∞·ªùi v·ªÅ c√πng khung gi·ªù ƒë·ªÉ test
            return await Task.FromResult(new List<Overtime>
            {
                new Overtime 
                { 
                    Code = "NV001", 
                    Name = "Nguy·ªÖn VƒÉn A", 
                    Date = DateTime.Now.AddMinutes(-115), // S·∫Ω v·ªÅ sau 5 ph√∫t
                    Hours = 2 
                },
                new Overtime 
                { 
                    Code = "NV002", 
                    Name = "Tr·∫ßn Th·ªã B", 
                    Date = DateTime.Now.AddMinutes(-115), // S·∫Ω v·ªÅ sau 5 ph√∫t (c√πng gi·ªù v·ªõi NV001)
                    Hours = 2 
                },
                new Overtime 
                { 
                    Code = "NV003", 
                    Name = "L√™ VƒÉn C", 
                    Date = DateTime.Now.AddMinutes(-115), // S·∫Ω v·ªÅ sau 5 ph√∫t (c√πng gi·ªù v·ªõi NV001 v√† NV002)
                    Hours = 2 
                }
            });
        }
    }
}

/*
using AlerAudio.Models;
using Microsoft.Data.SqlClient;

namespace AlerAudio.Services
{
    // S·ª≠ d·ª•ng class n√†y khi k·∫øt n·ªëi v·ªõi SQL Server th·ª±c t·∫ø
    // C·∫ßn c√†i package: dotnet add package Microsoft.Data.SqlClient
    public class SqlServerOvertimeRepository : IOvertimeRepository
    {
        private readonly string _connectionString;

        public SqlServerOvertimeRepository(string connectionString)
        {
            _connectionString = connectionString;
        }

        public async Task<List<Overtime>> GetOvertimesAsync()
        {
            var overtimes = new List<Overtime>();

            using (var connection = new SqlConnection(_connectionString))
            {
                await connection.OpenAsync();

                var query = @"
                    SELECT Code, Name, Date, Hours 
                    FROM Overtime 
                    WHERE Date >= CAST(GETDATE() AS DATE)
                    ORDER BY Date, Code";

                using (var command = new SqlCommand(query, connection))
                {
                    using (var reader = await command.ExecuteReaderAsync())
                    {
                        while (await reader.ReadAsync())
                        {
                            overtimes.Add(new Overtime
                            {
                                Code = reader.GetString(0),
                                Name = reader.GetString(1),
                                Date = reader.GetDateTime(2),
                                Hours = reader.GetDouble(3)
                            });
                        }
                    }
                }
            }

            return overtimes;
        }
    }
}
*/
using System.Speech.Synthesis;
using System.Globalization;
using NAudio.Wave;

namespace AlerAudio.Services
{
    public class TextToSpeechService : ITextToSpeechService, IDisposable
    {
        private readonly SpeechSynthesizer _synthesizer;
        private readonly bool _hasVietnameseVoice;
        private readonly string _audioFolder;

        public TextToSpeechService()
        {
            _synthesizer = new SpeechSynthesizer();
            
            // ƒê∆∞·ªùng d·∫´n ƒë·∫øn folder ch·ª©a audio files
            _audioFolder = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "AudioFiles");
            
            // T·∫°o folder n·∫øu ch∆∞a c√≥
            if (!Directory.Exists(_audioFolder))
            {
                Directory.CreateDirectory(_audioFolder);
                Console.WriteLine($"üìÅ ƒê√£ t·∫°o folder audio: {_audioFolder}");
                Console.WriteLine("üí° Vui l√≤ng th√™m c√°c file audio:");
                Console.WriteLine("   - start.mp3 (ho·∫∑c .wav) - Audio m·ªü ƒë·∫ßu th√¥ng b√°o");
                Console.WriteLine("   - end.mp3 (ho·∫∑c .wav) - Audio k·∫øt th√∫c th√¥ng b√°o");
                Console.WriteLine("   - NV001.mp3, NV002.mp3, ... - Audio cho t·ª´ng nh√¢n vi√™n");
                Console.WriteLine();
            }
            
            // T√¨m v√† ch·ªçn gi·ªçng ti·∫øng Vi·ªát n·∫øu c√≥
            var vietnameseVoice = _synthesizer.GetInstalledVoices()
                .FirstOrDefault(v => v.VoiceInfo.Culture.Name.StartsWith("vi"));

            if (vietnameseVoice != null)
            {
                _synthesizer.SelectVoice(vietnameseVoice.VoiceInfo.Name);
                _hasVietnameseVoice = true;
                Console.WriteLine($"‚úì ƒêang s·ª≠ d·ª•ng gi·ªçng ti·∫øng Vi·ªát: {vietnameseVoice.VoiceInfo.Name}");
            }
            else
            {
                _hasVietnameseVoice = false;
                var femaleVoice = _synthesizer.GetInstalledVoices()
                    .FirstOrDefault(v => v.VoiceInfo.Gender == VoiceGender.Female);
                
                if (femaleVoice != null)
                {
                    _synthesizer.SelectVoice(femaleVoice.VoiceInfo.Name);
                }
                
                Console.WriteLine("‚ö† Ch∆∞a c√†i gi·ªçng ti·∫øng Vi·ªát - ƒêang d√πng gi·ªçng m·∫∑c ƒë·ªãnh");
                Console.WriteLine("üìå H∆∞·ªõng d·∫´n c√†i gi·ªçng ti·∫øng Vi·ªát:");
                Console.WriteLine("   1. M·ªü Settings > Time & Language > Language");
                Console.WriteLine("   2. Add Vietnamese language");
                Console.WriteLine("   3. Download Text-to-Speech package");
                Console.WriteLine();
                Console.WriteLine("C√°c gi·ªçng c√≥ s·∫µn:");
                foreach (var voice in _synthesizer.GetInstalledVoices())
                {
                    var gender = voice.VoiceInfo.Gender == VoiceGender.Female ? "N·ªØ" : "Nam";
                    Console.WriteLine($"   - {voice.VoiceInfo.Name} ({voice.VoiceInfo.Culture.Name}) [{gender}]");
                }
                Console.WriteLine();
            }
            
            _synthesizer.Rate = _hasVietnameseVoice ? 0 : -1;
            _synthesizer.Volume = 100;
        }

        public void PlayAudioFile(string employeeCode)
        {
            PlayAudioFileAsync(employeeCode).GetAwaiter().GetResult();
        }

        public async Task PlayStartAudioAsync()
        {
            await PlaySpecialAudioAsync("start", "üîî M·ªü ƒë·∫ßu");
        }

        public async Task PlayEndAudioAsync()
        {
            await PlaySpecialAudioAsync("end", "‚úÖ K·∫øt th√∫c");
        }

        private async Task PlaySpecialAudioAsync(string fileName, string description)
        {
            try
            {
                var audioExtensions = new[] { ".mp3", ".wav", ".wma", ".m4a" };
                string? audioFile = null;

                foreach (var ext in audioExtensions)
                {
                    var filePath = Path.Combine(_audioFolder, $"{fileName}{ext}");
                    if (File.Exists(filePath))
                    {
                        audioFile = filePath;
                        break;
                    }
                }

                if (audioFile != null && File.Exists(audioFile))
                {
                    Console.WriteLine($"üîä {description}: {Path.GetFileName(audioFile)}");
                    await Task.Run(() => PlayAudio(audioFile));
                }
                else
                {
                    Console.WriteLine($"‚ö† Kh√¥ng t√¨m th·∫•y file {fileName}.mp3/.wav trong folder {_audioFolder}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå L·ªói ph√°t {fileName} audio: {ex.Message}");
            }
        }

        public async Task PlayAudioFileAsync(string employeeCode)
        {
            try
            {
                // T√¨m file audio c·ªßa nh√¢n vi√™n (h·ªó tr·ª£ nhi·ªÅu ƒë·ªãnh d·∫°ng)
                var audioExtensions = new[] { ".mp3", ".wav", ".wma", ".m4a" };
                string? audioFile = null;

                foreach (var ext in audioExtensions)
                {
                    var filePath = Path.Combine(_audioFolder, $"{employeeCode}{ext}");
                    if (File.Exists(filePath))
                    {
                        audioFile = filePath;
                        break;
                    }
                }

                if (audioFile != null && File.Exists(audioFile))
                {
                    Console.WriteLine($"üîä Ph√°t file audio: {Path.GetFileName(audioFile)}");
                    await Task.Run(() => PlayAudio(audioFile));
                }
                else
                {
                    Console.WriteLine($"‚ö† Kh√¥ng t√¨m th·∫•y file audio cho m√£ {employeeCode} trong folder {_audioFolder}");
                    Console.WriteLine($"üí° T·∫°o file: {employeeCode}.mp3 ho·∫∑c {employeeCode}.wav");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå L·ªói ph√°t audio cho {employeeCode}: {ex.Message}");
            }
        }

        private void PlayAudio(string audioFile)
        {
            try
            {
                using (var audioFileReader = new AudioFileReader(audioFile))
                using (var outputDevice = new WaveOutEvent())
                {
                    outputDevice.Init(audioFileReader);
                    outputDevice.Play();

                    // ƒê·ª£i ph√°t xong
                    while (outputDevice.PlaybackState == PlaybackState.Playing)
                    {
                        Thread.Sleep(100);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå L·ªói khi ph√°t file {Path.GetFileName(audioFile)}: {ex.Message}");
            }
        }

        public void Speak(string text)
        {
            try
            {
                string textToSpeak = _hasVietnameseVoice ? text : SimplifyForEnglishVoice(text);
                _synthesizer.Speak(textToSpeak);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå L·ªói ph√°t √¢m: {ex.Message}");
                Console.WriteLine($"üì¢ TH√îNG B√ÅO: {text}");
            }
        }

        public async Task SpeakAsync(string text)
        {
            try
            {
                string textToSpeak = _hasVietnameseVoice ? text : SimplifyForEnglishVoice(text);
                await Task.Run(() => _synthesizer.Speak(textToSpeak));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå L·ªói ph√°t √¢m: {ex.Message}");
                Console.WriteLine($"üì¢ TH√îNG B√ÅO: {text}");
            }
        }

        private string SimplifyForEnglishVoice(string text)
        {
            return text
                .Replace("Xin m·ªùi m√£ s·ªë", "Code")
                .Replace("m√£ s·ªë", "Code")
                .Replace("vui l√≤ng chu·∫©n b·ªã v·ªÅ", "please prepare to leave")
                .Replace("vui l√≤ng", "please");
        }

        public void Dispose()
        {
            _synthesizer?.Dispose();
        }
    }
}

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <PlatformTarget>AnyCPU</PlatformTarget>
    <UseWindowsForms>true</UseWindowsForms>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Hosting" Version="8.0.0" />
    <PackageReference Include="Microsoft.Extensions.Logging.Console" Version="8.0.0" />
    <PackageReference Include="NAudio" Version="2.2.1" />
    <PackageReference Include="System.Speech" Version="8.0.0" />
  </ItemGroup>

</Project>
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=YourDatabase;User Id=sa;Password=YourPassword;TrustServerCertificate=True;"
  },
  "AlertSettings": {
    "CheckIntervalSeconds": 60,
    "AlertMinutesBefore": 10,
    "SpeechRate": 0,
    "SpeechVolume": 100
  }
}

using AlerAudio.Services;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

var builder = Host.CreateApplicationBuilder(args);

// ƒêƒÉng k√Ω services
builder.Services.AddSingleton<IOvertimeRepository, OvertimeRepository>();
builder.Services.AddSingleton<ITextToSpeechService, TextToSpeechService>();
builder.Services.AddHostedService<OvertimeAlertService>();

// C·∫•u h√¨nh logging
builder.Logging.ClearProviders();
builder.Logging.AddConsole();

var host = builder.Build();

Console.WriteLine("=== H·ªá Th·ªëng C·∫£nh B√°o Gi·ªù V·ªÅ ===");
Console.WriteLine("Service ƒëang ch·∫°y...");
Console.WriteLine("Ki·ªÉm tra t·ª± ƒë·ªông m·ªói 60 gi√¢y");
Console.WriteLine("Nh·∫•n Ctrl+C ƒë·ªÉ d·ª´ng");
Console.WriteLine("=====================================\n");

await host.RunAsync();



## Audio setUp
# H∆∞·ªõng D·∫´n C√†i ƒê·∫∑t File Audio

## C·∫•u tr√∫c th∆∞ m·ª•c

·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông t·∫°o folder `AudioFiles` trong th∆∞ m·ª•c ch·ª©a file exe:

```
AlerAudio/
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îî‚îÄ‚îÄ Debug/
‚îÇ       ‚îî‚îÄ‚îÄ net8.0-windows/
‚îÇ           ‚îú‚îÄ‚îÄ AlerAudio.exe
‚îÇ           ‚îî‚îÄ‚îÄ AudioFiles/          ‚Üê Folder ch·ª©a file audio
‚îÇ               ‚îú‚îÄ‚îÄ NV001.mp3
‚îÇ               ‚îú‚îÄ‚îÄ NV002.mp3
‚îÇ               ‚îú‚îÄ‚îÄ NV003.wav
‚îÇ               ‚îî‚îÄ‚îÄ ...
```

## C√°ch t·∫°o file audio

### T√™n file
- **T√™n file ph·∫£i tr√πng v·ªõi m√£ nh√¢n vi√™n** (Code trong database)
- V√≠ d·ª•: `NV001.mp3`, `NV002.wav`, `EMP123.mp3`

### ƒê·ªãnh d·∫°ng h·ªó tr·ª£
- ‚úÖ `.mp3`
- ‚úÖ `.wav`
- ‚úÖ `.wma`
- ‚úÖ `.m4a`

### N·ªôi dung audio
B·∫°n c√≥ th·ªÉ thu √¢m ho·∫∑c t·∫°o file audio v·ªõi n·ªôi dung nh∆∞:
- "Xin m·ªùi anh/ch·ªã Nguy·ªÖn VƒÉn A vui l√≤ng chu·∫©n b·ªã v·ªÅ"
- "Nh√¢n vi√™n m√£ s·ªë NV001, Nguy·ªÖn VƒÉn A, ƒë√£ ƒë·∫øn gi·ªù v·ªÅ"
- Ho·∫∑c b·∫•t k·ª≥ n·ªôi dung n√†o b·∫°n mu·ªën

## C√°ch t·∫°o file audio

### C√°ch 1: Thu √¢m tr·ª±c ti·∫øp
1. S·ª≠ d·ª•ng **Voice Recorder** tr√™n Windows
2. Thu √¢m n·ªôi dung th√¥ng b√°o
3. L∆∞u file v·ªõi t√™n l√† m√£ nh√¢n vi√™n (VD: `NV001.mp3`)
4. Copy v√†o folder `AudioFiles`

### C√°ch 2: S·ª≠ d·ª•ng Text-to-Speech online
1. Truy c·∫≠p: https://ttsmp3.com/text-to-speech/Vietnamese/
2. Nh·∫≠p n·ªôi dung: "Xin m·ªùi anh Nguy·ªÖn VƒÉn A vui l√≤ng chu·∫©n b·ªã v·ªÅ"
3. Ch·ªçn gi·ªçng ti·∫øng Vi·ªát
4. Download file MP3
5. ƒê·ªïi t√™n file th√†nh m√£ nh√¢n vi√™n (VD: `NV001.mp3`)
6. Copy v√†o folder `AudioFiles`

### C√°ch 3: S·ª≠ d·ª•ng c√¥ng c·ª• chuy√™n nghi·ªáp
- **Audacity** (mi·ªÖn ph√≠)
- **Adobe Audition**
- **WavePad**

## C√°ch ho·∫°t ƒë·ªông

### Khi c√≥ 1 ng∆∞·ªùi v·ªÅ:
```
L·∫ßn 1: Ph√°t NV001.mp3
Ngh·ªâ 1.5 gi√¢y
L·∫ßn 2: Ph√°t NV001.mp3
Ngh·ªâ 1.5 gi√¢y
L·∫ßn 3: Ph√°t NV001.mp3
```

### Khi c√≥ nhi·ªÅu ng∆∞·ªùi v·ªÅ c√πng l√∫c:
```
L·∫ßn 1: 
  - Ph√°t NV001.mp3
  - Delay 0.5s
  - Ph√°t NV002.mp3
  - Delay 0.5s
  - Ph√°t NV003.mp3
Ngh·ªâ 2 gi√¢y

L·∫ßn 2:
  - Ph√°t NV001.mp3
  - Delay 0.5s
  - Ph√°t NV002.mp3
  - Delay 0.5s
  - Ph√°t NV003.mp3
Ngh·ªâ 2 gi√¢y

L·∫ßn 3:
  - Ph√°t NV001.mp3
  - Delay 0.5s
  - Ph√°t NV002.mp3
  - Delay 0.5s
  - Ph√°t NV003.mp3
```

## L∆∞u √Ω

- ‚ö†Ô∏è **N·∫øu kh√¥ng t√¨m th·∫•y file audio** cho m√£ nh√¢n vi√™n, h·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã c·∫£nh b√°o trong log
- üí° N√™n t·∫°o file audio cho t·∫•t c·∫£ nh√¢n vi√™n c√≥ th·ªÉ l√†m th√™m gi·ªù
- üîä Test file audio tr∆∞·ªõc khi s·ª≠ d·ª•ng ƒë·ªÉ ƒë·∫£m b·∫£o √¢m thanh r√µ r√†ng
- üìÅ ƒê·∫∑t file audio v√†o ƒë√∫ng folder `AudioFiles` trong th∆∞ m·ª•c exe

## Ki·ªÉm tra

Khi kh·ªüi ƒë·ªông ·ª©ng d·ª•ng, n·∫øu ch∆∞a c√≥ folder `AudioFiles`, h·ªá th·ªëng s·∫Ω:
1. T·ª± ƒë·ªông t·∫°o folder
2. Hi·ªÉn th·ªã ƒë∆∞·ªùng d·∫´n folder
3. Nh·∫Øc nh·ªü th√™m file audio

## V√≠ d·ª•

```
üìÅ ƒê√£ t·∫°o folder audio: E:\...\AlerAudio\bin\Debug\net8.0-windows\AudioFiles
üí° Vui l√≤ng th√™m c√°c file audio v·ªõi t√™n l√† m√£ nh√¢n vi√™n (VD: NV001.mp3, NV002.wav)
```


##Configuration 



# H∆∞·ªõng D·∫´n C·∫•u H√¨nh Chi Ti·∫øt

## T√πy ch·ªânh th·ªùi gian ki·ªÉm tra v√† c·∫£nh b√°o

### 1. Thay ƒë·ªïi kho·∫£ng th·ªùi gian ki·ªÉm tra (m·∫∑c ƒë·ªãnh 60 gi√¢y)

M·ªü file `Services/OvertimeAlertService.cs`, t√¨m d√≤ng:
```csharp
private readonly int _checkIntervalSeconds = 60;
```

Thay ƒë·ªïi th√†nh th·ªùi gian mong mu·ªën (ƒë∆°n v·ªã: gi√¢y):
```csharp
private readonly int _checkIntervalSeconds = 30; // Ki·ªÉm tra m·ªói 30 gi√¢y
```

### 2. Thay ƒë·ªïi th·ªùi gian c·∫£nh b√°o tr∆∞·ªõc (m·∫∑c ƒë·ªãnh 10 ph√∫t)

T√¨m d√≤ng:
```csharp
private readonly int _alertMinutesBefore = 10;
```

Thay ƒë·ªïi th√†nh:
```csharp
private readonly int _alertMinutesBefore = 15; // C·∫£nh b√°o tr∆∞·ªõc 15 ph√∫t
```

## T√πy ch·ªânh gi·ªçng n√≥i

M·ªü file `Services/TextToSpeechService.cs`:

### 1. Thay ƒë·ªïi t·ªëc ƒë·ªô n√≥i
```csharp
_synthesizer.Rate = 0; // -10 (ch·∫≠m nh·∫•t) ƒë·∫øn 10 (nhanh nh·∫•t)
```

### 2. Thay ƒë·ªïi √¢m l∆∞·ª£ng
```csharp
_synthesizer.Volume = 100; // 0 (im l·∫∑ng) ƒë·∫øn 100 (to nh·∫•t)
```

### 3. Thay ƒë·ªïi gi·ªçng nam/n·ªØ
```csharp
// Gi·ªçng n·ªØ
_synthesizer.SelectVoiceByHints(VoiceGender.Female, VoiceAge.Adult);

// Gi·ªçng nam
_synthesizer.SelectVoiceByHints(VoiceGender.Male, VoiceAge.Adult);
```

## T√πy ch·ªânh n·ªôi dung th√¥ng b√°o

M·ªü file `Services/OvertimeAlertService.cs`, t√¨m c√°c d√≤ng:

### Th√¥ng b√°o cho 1 ng∆∞·ªùi:
```csharp
var message = $"Xin m·ªùi m√£ s·ªë {employee.Code}, {employee.Name}, vui l√≤ng chu·∫©n b·ªã v·ªÅ";
```

C√≥ th·ªÉ thay ƒë·ªïi th√†nh:
```csharp
var message = $"Ch√†o {employee.Name}, b·∫°n s·∫Øp h·∫øt gi·ªù l√†m th√™m, vui l√≤ng chu·∫©n b·ªã k·∫øt th√∫c c√¥ng vi·ªác";
```

### Th√¥ng b√°o cho nhi·ªÅu ng∆∞·ªùi:
```csharp
var message = $"Xin m·ªùi {namesList}, vui l√≤ng chu·∫©n b·ªã v·ªÅ";
```

## K·∫øt n·ªëi v·ªõi Database th·ª±c t·∫ø

### S·ª≠ d·ª•ng SQL Server

1. C√†i ƒë·∫∑t package:
```bash
dotnet add package Microsoft.Data.SqlClient
```

2. B·ªè comment trong file `Services/SqlServerOvertimeRepository.cs`

3. C·∫≠p nh·∫≠t `appsettings.json`:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=YOUR_SERVER;Database=YOUR_DB;User Id=sa;Password=YOUR_PASS;TrustServerCertificate=True;"
  }
}
```

4. Thay ƒë·ªïi `Program.cs`:
```csharp
// ƒê·ªçc connection string t·ª´ appsettings.json
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");

// Thay ƒë·ªïi t·ª´:
builder.Services.AddSingleton<IOvertimeRepository, OvertimeRepository>();

// Th√†nh:
builder.Services.AddSingleton<IOvertimeRepository>(sp => 
    new SqlServerOvertimeRepository(connectionString ?? ""));
```

### S·ª≠ d·ª•ng MySQL

1. C√†i ƒë·∫∑t package:
```bash
dotnet add package MySql.Data
```

2. T·∫°o `MySqlOvertimeRepository.cs` t∆∞∆°ng t·ª± nh∆∞ `SqlServerOvertimeRepository.cs`

## Ch·∫°y nh∆∞ Windows Service

ƒê·ªÉ ch·∫°y ·ª©ng d·ª•ng nh∆∞ m·ªôt Windows Service:

1. C√†i ƒë·∫∑t package:
```bash
dotnet add package Microsoft.Extensions.Hosting.WindowsServices
```

2. Thay ƒë·ªïi `Program.cs`:
```csharp
var builder = Host.CreateApplicationBuilder(args);

// Th√™m d√≤ng n√†y
builder.Services.AddWindowsService();

// ... c√°c services kh√°c
```

3. Publish ·ª©ng d·ª•ng:
```bash
dotnet publish -c Release -r win-x64 --self-contained
```

4. T·∫°o Windows Service:
```powershell
sc.exe create "OvertimeAlertService" binPath="C:\path\to\AlerAudio.exe"
sc.exe start "OvertimeAlertService"
```

## Logging v√†o file

ƒê·ªÉ l∆∞u log v√†o file, c√†i ƒë·∫∑t:
```bash
dotnet add package Serilog.Extensions.Hosting
dotnet add package Serilog.Sinks.File
```

Th√™m v√†o `Program.cs`:
```csharp
using Serilog;

Log.Logger = new LoggerConfiguration()
    .WriteTo.File("logs/overtime-alert-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();

builder.Services.AddLogging(loggingBuilder =>
{
    loggingBuilder.AddSerilog();
});
```

## G·ª≠i email th√¥ng b√°o

ƒê·ªÉ g·ª≠i email th√™m v√†o th√¥ng b√°o √¢m thanh:

1. C√†i ƒë·∫∑t:
```bash
dotnet add package MailKit
```

2. T·∫°o `EmailService.cs` v√† g·ªçi trong `OvertimeAlertService.cs`



# H∆∞·ªõng D·∫´n K·∫øt N·ªëi Database

## B∆∞·ªõc 1: C√†i ƒë·∫∑t package SQL Server

```bash
dotnet add package Microsoft.Data.SqlClient
```

## B∆∞·ªõc 2: T·∫°o b·∫£ng trong SQL Server

Ch·∫°y script trong file `Database/CreateTable.sql` tr√™n SQL Server c·ªßa b·∫°n.

## B∆∞·ªõc 3: C·∫•u h√¨nh Connection String

Ch·ªânh s·ª≠a file `appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=YOUR_SERVER;Database=YOUR_DATABASE;User Id=YOUR_USER;Password=YOUR_PASSWORD;TrustServerCertificate=True;"
  }
}
```

## B∆∞·ªõc 4: S·ª≠ d·ª•ng SqlServerOvertimeRepository

Trong file `Program.cs`, thay ƒë·ªïi:

```csharp
// T·ª´:
builder.Services.AddSingleton<IOvertimeRepository, OvertimeRepository>();

// Th√†nh:
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");
builder.Services.AddSingleton<IOvertimeRepository>(sp => 
    new SqlServerOvertimeRepository(connectionString));
```

## B∆∞·ªõc 5: Ch·∫°y ·ª©ng d·ª•ng

```bash
dotnet run
```

---

## S·ª≠ d·ª•ng v·ªõi Entity Framework Core (T√πy ch·ªçn)

### 1. C√†i ƒë·∫∑t packages:

```bash
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
dotnet add package Microsoft.EntityFrameworkCore.Tools
```

### 2. T·∫°o DbContext:

```csharp
public class AppDbContext : DbContext
{
    public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) { }
    
    public DbSet<Overtime> Overtimes { get; set; }
}
```

### 3. ƒêƒÉng k√Ω trong Program.cs:

```csharp
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
```

### 4. T·∫°o EF Repository:

```csharp
public class EfOvertimeRepository : IOvertimeRepository
{
    private readonly AppDbContext _context;
    
    public EfOvertimeRepository(AppDbContext context)
    {
        _context = context;
    }
    
    public async Task<List<Overtime>> GetOvertimesAsync()
    {
        return await _context.Overtimes
            .Where(o => o.Date.Date == DateTime.Today)
            .OrderBy(o => o.Date)
            .ToListAsync();
    }
}
```
